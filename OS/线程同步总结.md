[toc]
# 线程同步
---
## 竞争与协作

## 同步的概念
同步，**就是并发进程/线程在一些关键点上可能需要互相等待与互通消息，这种相互制约的等待与互通信息称为进程/线程同步。**

## 互斥的概念
互斥（mutualexclusion）的，也就说保证一个线程在临界区执行时，其他线程应该被阻止进入临界区。

<font color=red>注意，同步与互斥是两种不同的概念：</font>

同步就好比：「操作 A 应在操作 B 之前执行」，「操作 C 必须在操作 A 和操作 B 都完成之后才能执行」等；
互斥就好比：「操作 A 和操作 B 不能在同一时刻执行」；

## 互斥与同步的实现和使用
在进程/线程并发执行的过程中，进程/线程之间存在协作的关系，例如有互斥、同步的关系。
为了实现进程/线程间正确的协作，操作系统必须提供实现进程协作的措施和方法，主要的方法有两种：
- 锁：加锁、解锁操作
- 信号量：PV原语

**锁：**
使用加锁操作和解锁操作可以解决并发线程/进程的互斥问题。
**任何想进入临界区的线程，必须先执行加锁操作**。若加锁操作顺利通过，则线程可进入临界区；在完成对临界资源的访问后再执行解锁操作，以释放该临界资源。
![asserts/661.webp](asserts/662.webp)

根据锁的实现不同，可以分为「`忙等待锁`」和「`无忙等待锁`」。
**忙等待锁**
也就是当获取获取不到锁时，线程就会一直while循环，不做任何事情，也叫做自旋锁。
这是最简单的一种所，一直自旋，利用CPU周期，直到锁可以用。单处理器上，需要使用抢占式的调度器，否则自旋锁会一直自旋不放弃cpu。
**无忙等待锁**
获取不到锁的时候不用自旋，即**当没获取到锁就会放入等待队列，然后执行调度程序，把cpu让出。**

**信号量：**

信号量是操作系统提供的一种协调共享资源访问的方法，**这是由操作系统实现的原子性操作。**

通常**信号量表示资源的数量**，对应的变量是一个整型（sem）变量。

另外，还有两个原子操作的系统调用函数来控制信号量的，分别是：
- P：表示-1，如果减完之后变量<0，则进程、线程进入阻塞等待，P可能会阻塞。
- V：表示+1，相加后如果变量<=0，唤醒一个等待的进程/线程，V操作不会阻塞。
P 操作是用在进入临界区之前，V 操作是用在离开临界区之后，**这两个操作是必须成对出现的**。

**PV操作的使用：**
信号量不仅可以实现**临界区的互斥访问控制**，还可以**线程间的事件同步**。
1. 临界区的互斥访问
   为每类共享资源设置一个信号量 s，**其初值为 1**，表示该临界资源未被占用。
   通过互斥信号量的方式，就能保证临界区任何时刻只有一个线程在执行，就达到了互斥的效果。

2. 信号量实现事件同步
   PV的组合操作，达到两个线程交互通信的目的。

## 生产者-消费者问题
**生产者-消费者问题描述**：

- 生产者在生成数据后，放在一个缓冲区中；
- 消费者从缓冲区取出数据处理；
- 任何时刻，只能有一个生产者或消费者可以访问缓冲区；

我们对问题分析可以得出：

- 任何时刻只能有一个线程操作缓冲区，说明操作缓冲区是临界代码，需要互斥；
- 缓冲区空时，消费者必须等待生产者生成数据；缓冲区满时，生产者必须等待消费者取出数据。说明生产者和消费者需要同步。

那么**我们需要三个信号量**，分别是：
- 互斥信号量 mutex：用于互斥访问缓冲区，初始化值为 1；
- 资源信号量 fullBuffers：用于消费者询问缓冲区是否有数据，有数据则读取数据，初始化值为 0（表明缓冲区一开始为空）；
- 资源信号量 emptyBuffers：用于生产者询问缓冲区是否有空位，有空位则生成数据，初始化值为 n （缓冲区大小）；

## 哲学家就餐问题 
**如何保证哲学家们的动作有序进行，而不会出现饿死？**

**方案1：** 使用信号量的方式，PV操作。
拿起叉子使用P操作，代表有叉子就直接用，没有叉子就等待。**这种解法存在极端情况：每个哲学家都只拿一侧的叉子，那么全都不满足两个叉子的条件，一起死锁。**

**方案2**：在1的基础上，拿叉子之前加锁互斥量。互斥信号量的作用就在于，**只要有一个哲学家进入了「临界区」，也就是准备要拿叉子时，其他哲学家都不能动，只有这位哲学家用完叉子了，才能轮到下一个哲学家进餐。** 但是效率太低。

**方案3**：互斥信号量，会导致只能允许一个哲学家就餐，那么我们就不用它。采用分支结构，根据哲学家的编号的不同，而采取不同的动作。**即让偶数编号的哲学家「先拿左边的叉子后拿右边的叉子」，奇数编号的哲学家「先拿右边的叉子后拿左边的叉子」。**
不会思索且两人进餐。

**方案4**：**用一个数组 state 来记录每一位哲学家在进程、思考还是饥饿状态（正在试图拿叉子）。**
那么，一个哲学家只有在两个邻居都没有进餐时，才可以进入进餐状态。

## 读者-写着
- 「读-读」允许：同一时刻，允许多个读者同时读
- 「读-写」互斥：没有写者时读者才能读，没有读者时写者才能写
- 「写-写」互斥：没有其他写者时，写者才能写



